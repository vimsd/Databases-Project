<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Select Seat</title>
</head>
<body>

<h1>Select Seat</h1>
<ul id="seats"></ul>

<script>
const showtime_id = new URLSearchParams(location.search).get("showtime_id");

fetch(`/api/seats?showtime_id=${showtime_id}`)
  .then(r => r.json())
  .then(data => {
    const ul = document.getElementById("seats");
    data.forEach(s => {
      if (s.status === "free") {
        ul.innerHTML += `
          <li>
            ${s.seat}
            <button onclick="book(${s.seat_id})">Book</button>
          </li>
        `;
      } else if (s.status === "pending") {
        ul.innerHTML += `<li>${s.seat} (Pending)</li>`;
      } else {
        ul.innerHTML += `<li>${s.seat} (Booked)</li>`;
      }
    });
  });

function book(seat_id) {
  fetch("/api/booking", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      user_id: 1,
      showtime_id: showtime_id,
      seat_id: seat_id,
      amount: 250
    })
  })
  .then(r => r.json())
  .then(async res => {
    if (res.error) throw res;
    if (!confirm(`Pay ${res.amount}?`)) {
      await fetch("/api/booking/cancel", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ book_id: res.book_id })
      });
      location.reload();
      return;
    }
    const pay = await fetch("/api/booking/confirm", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ book_id: res.book_id })
    });
    const payRes = await pay.json();
    if (payRes.error) throw payRes;
    alert("Payment confirmed");
    location.reload();
  })
  .catch(e => alert(e.error || e.message || "Booking failed"));
}

function book(seat_id) {
  fetch("/api/booking", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      user_id: 1,
      showtime_id: showtime_id,
      seat_id: seat_id,
      amount: 250
    })
  })
  .then(r => r.json())
  .then(res => {
    alert(res.message);
    location.reload();
  })
  .catch(() => alert("Booking failed"));
}
</script>

</body>
</html>
